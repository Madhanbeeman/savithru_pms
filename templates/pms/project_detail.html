{% extends base_template %}
{% load static %}
{% load pms_extras %}

{% block title %}Project: {{ project.name }}{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Project Details: {{ project.name }}</h2>
    <div>
        {% if is_manager %}
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#add-rec-modal">
                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12 5l0 14" /><path d="M5 12l14 0" /></svg>
                New Recommendation
            </button>
        {% endif %}
        
        {% if is_manager or is_team_head %}
            <a href="{% url 'edit_project' project.id %}" class="btn btn-outline-info btn-sm">Edit Project</a>
        {% endif %}
        
        <a href="{% url 'project_list' %}" class="btn btn-secondary btn-sm">Back to Project List</a>
    </div>
</div>

{% if messages %}
    {% for message in messages %}
    <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
{% endif %}

<div class="row">
    <div class="col-lg-8">
        
        <div class="card shadow-sm project-details-card mb-4">
            <div class="card-header"><h5 class="mb-0">Project Information</h5></div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">Team Head:</dt> <dd class="col-sm-9">{{ project.team_head.username|default:"N/A" }}</dd>
                    <dt class="col-sm-3">Client:</dt> <dd class="col-sm-9">{{ project.client_name|default:"-" }}</dd>
                    <dt class="col-sm-3">Status:</dt> <dd class="col-sm-9">{{ project.get_status_display }}</dd>
                    <dt class="col-sm-3">Priority:</dt> <dd class="col-sm-9">{{ project.get_priority_display }}</dd>
                    <dt class="col-sm-3">Dates:</dt> <dd class="col-sm-9">{{ project.start_date|date:"Y-m-d" }} to {{ project.end_date|date:"Y-m-d" }}</dd>
                    <dt class="col-sm-3">Description:</dt> <dd class="col-sm-9">{{ project.description|linebreaksbr|default:"No description." }}</dd>
                </dl>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">Recommendations</h5></div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                <div class="list-group list-group-flush">
                    {% for rec in recommendations %}
                    <div class="list-group-item mb-3 border rounded p-3 bg-light-lt">
                        <div class="d-flex justify-content-between mb-2">
                            <h4 class="mb-0 text-primary">{{ rec.title }}</h4>
                            <div class="text-end">
                                <small class="text-muted d-block">{{ rec.created_at|date:"M d, Y" }}</small>
                                <small class="text-muted">by {{ rec.user.username }}</small>
                            </div>
                        </div>
                        {% if rec.end_date %}<div class="mb-2"><span class="badge bg-warning-lt">End Date: {{ rec.end_date }}</span></div>{% endif %}
                        <div class="mb-2">{{ rec.remarks|linebreaks }}</div>
                        {% if rec.attachments.all %}
                        <div class="mt-2 pt-2 border-top"><strong>Files:</strong> {% for att in rec.attachments.all %}<a href="{{ att.file.url }}" target="_blank" class="ms-1">{{ att.file.name|cut:"project_updates/" }}</a>{% endfor %}</div>
                        {% endif %}
                    </div>
                    {% empty %}
                    <p class="text-center text-muted">No recommendations posted yet.</p>
                    {% endfor %}
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4">
            <div class="card-header"><h5 class="mb-0">Project Documents</h5></div>
            <div class="card-body">
                {% if request.user == project.team_head %}
                <form method="POST" enctype="multipart/form-data" class="mb-3">
                    {% csrf_token %}
                    <div class="input-group mb-2">
                        {{ doc_form.document }}
                        <button type="submit" name="submit_document" class="btn btn-primary">Upload</button>
                    </div>
                    {{ doc_form.description }}
                </form>
                <hr>
                {% endif %}
                <ul class="list-group list-group-flush">
                    {% for doc in documents %}
                    <li class="list-group-item px-0">
                        <a href="{{ doc.document.url }}" target="_blank"><strong>{{ doc.description|default:doc.document.name }}</strong></a>
                        <small class="text-muted">By {{ doc.uploaded_by.username }} ({{ doc.uploaded_at|date:"M d" }})</small>
                    </li>
                    {% empty %}
                    <p class="text-muted small text-center mb-0">No documents uploaded.</p>
                    {% endfor %}
                </ul>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        
        <div class="card shadow-sm mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Team Members & Time</h5>
            </div>
            <div class="bg-light p-2 border-bottom text-center">
                <span class="text-muted small">TOTAL PROJECT TIME</span>
                <div class="h2 m-0 text-primary">{{ project_total_time }}</div>
            </div>
            <ul class="list-group list-group-flush list-group-hoverable">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <span class="fw-medium">{{ project.team_head.get_full_name|default:project.team_head.username }}</span>
                        <small class="d-block text-muted">Team Head</small>
                    </div>
                    <span class="badge bg-primary-lt">HEAD</span>
                </li>
                
                {% for member in team_members %}
                    {% if member.user != project.team_head %}
                    <li class="list-group-item d-flex justify-content-between align-items-center cursor-pointer" 
                        data-bs-toggle="modal" data-bs-target="#timeModal-{{ member.id }}" style="cursor: pointer;">
                        <div>
                            <span class="fw-medium">{{ member.user.get_full_name|default:member.user.username }}</span>
                            <small class="d-block text-muted">{{ member.user.email }}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge mb-1 
                                {% if member.role == 'DEVELOPER' %}bg-azure-lt
                                {% elif member.role == 'DESIGNER' %}bg-pink-lt
                                {% elif member.role == 'TESTER' %}bg-orange-lt
                                {% else %}bg-secondary-lt{% endif %}">
                                {{ member.get_role_display }}
                            </span>
                            {% if member.total_time_calculated %}
                                <br><small class="text-success fw-bold">{{ member.total_time_calculated }}</small>
                            {% endif %}
                        </div>
                    </li>

                    <div class="modal modal-blur fade" id="timeModal-{{ member.id }}" tabindex="-1" aria-hidden="true">
                        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Time Log: {{ member.user.username }}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="table-responsive">
                                        <table class="table table-vcenter card-table table-striped">
                                            <thead><tr><th>Date</th><th>Task</th><th class="text-end">Time</th></tr></thead>
                                            <tbody>
                                                {% for log in member.time_logs %}
                                                <tr>
                                                    <td class="text-muted small">{{ log.daily_update.date|date:"M d" }}</td>
                                                    <td>{{ log.task_page.page_name }}</td>
                                                    <td class="text-end fw-bold">{{ log.time_spent }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr><td colspan="3" class="text-center text-muted">No time logged.</td></tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div class="mt-3 text-end border-top pt-2"><strong>Total: {{ member.total_time_calculated }}</strong></div>
                                </div>
                                <div class="modal-footer"><button type="button" class="btn" data-bs-dismiss="modal">Close</button></div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                {% empty %}
                <li class="list-group-item text-muted text-center">No team members assigned.</li>
                {% endfor %}
            </ul>
        </div>
        
        <div class="card shadow-sm mb-4">
             <div class="card-body">
                 <div class="d-flex justify-content-between align-items-center mb-3">
                     <h3 class="card-title mb-0">Video Meeting</h3>
                     
                     {% if is_manager or is_team_head %}
                     <button type="button" class="btn btn-icon btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#edit-meet-modal" title="Edit Link">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-pencil" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" /><path d="M13.5 6.5l4 4" /></svg>
                     </button>
                     {% endif %}
                 </div>

                 {% if project.google_meet_link %}
                     <a href="{{ project.google_meet_link }}" target="_blank" class="btn btn-outline-success w-100 mb-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-google-meet" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M14 12m-9 0a9 9 0 1 0 18 0a9 9 0 1 0 -18 0" /><path d="M9 12l0 .01" /><path d="M15 12l0 .01" /><path d="M12 12l0 .01" /><path d="M12 12.01v-.01" /></svg>
                        Join Meeting
                    </a>

                    {% if is_manager or is_team_head %}
                    <form action="{% url 'end_project_meeting' project.id %}" method="POST" onsubmit="return confirm('Are you sure you want to end this meeting? This will remove the link.');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger w-100">
                            End Meeting
                        </button>
                    </form>
                    {% endif %}

                 {% else %}
                    <div class="text-center text-muted small py-2 bg-light rounded">
                        No active meeting.
                        {% if is_manager or is_team_head %}
                        <br><a href="#" data-bs-toggle="modal" data-bs-target="#edit-meet-modal">Start a Meeting</a>
                        {% endif %}
                    </div>
                 {% endif %}
             </div>
        </div>
        </div>
</div>

{% if is_manager %}
<div class="modal modal-blur fade" id="add-rec-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Recommendation</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label">Title</label>{{ rec_form.title }}</div>
                    <div class="mb-3"><label class="form-label">End Date</label>{{ rec_form.end_date }}</div>
                    <div class="mb-3"><label class="form-label">Description</label>{{ rec_form.remarks }}</div>
                    <hr>
                    <h5 class="mb-3">Attachments</h5>
                    {{ attachment_formset.management_form }}
                    <div id="rec-attachment-list">
                        {% for form in attachment_formset %}
                        <div class="row attachment-form mb-2"><div class="col-11">{{ form.file }}</div></div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer"><button type="button" class="btn me-auto" data-bs-dismiss="modal">Cancel</button><button type="submit" name="submit_recommendation" class="btn btn-primary">Submit</button></div>
            </form>
        </div>
    </div>
</div>
{% endif %}

{% if is_manager or is_team_head %}
<div class="modal modal-blur fade" id="edit-meet-modal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Meeting Link</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="POST">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Google Meet URL</label>
                        {{ meet_form.google_meet_link }}
                        <small class="form-hint">Paste the full link (e.g. https://meet.google.com/...)</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn me-auto" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" name="submit_meet_link" class="btn btn-primary">Save Link</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}