{% extends base_template %}
{% load static %}

{% block title %}Chat{% endblock %}

{% block extra_css %}
<style>
    .chat-container {
        display: flex;
        flex-direction: column;
        height: 70vh; /* 70% of the viewport height */
    }
    .chat-header {
        border-bottom: 1px solid var(--tblr-border-color);
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 1rem;
    }
    .chat-input {
        border-top: 1px solid var(--tblr-border-color);
    }
    .message {
        padding: 0.5rem 0.75rem;
        border-radius: 10px;
        margin-bottom: 0.5rem;
        max-width: 80%;
        box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    }
    .message-sent {
        background-color: #dcf8c6; /* Light green */
        color: #111;
        align-self: flex-end;
        margin-left: auto;
    }
    .message-received {
        background-color: #ffffff; /* White */
        color: #111;
        align-self: flex-start;
        margin-right: auto;
    }
    .message-timestamp {
        font-size: 0.75rem;
        color: rgba(0, 0, 0, 0.4);
        display: block;
        margin-top: 0.25rem;
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class.card">
    <div class="row g-0">
        <div class="col-12 col-lg-4 col-xl-3 border-end">
            <div class="card-header d-none d-md-block">
                <h3 class="card-title">Chat Contacts</h3>
            </div>
            <div class="list-group list-group-flush" style="max-height: 70vh; overflow-y: auto;">
                {% for user in chat_users %}
                <a href="{% url 'chat_detail' user.id %}" 
                   class="list-group-item list-group-item-action {% if selected_receiver and selected_receiver.id == user.id %}active{% endif %}">
                    <div class="d-flex align-items-center">
                        <span class="avatar me-3">{{ user.username.0|upper }}</span>
                        <div class="flex-fill">
                            <div>{{ user.get_full_name|default:user.username }}</div>
                            <div class="text-muted small">{{ user.get_role_display }}</div>
                        </div>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>

        <div class="col-12 col-lg-8 col-xl-9">
            {% if selected_receiver %}
            <div class="chat-container">
                <div class="chat-header p-3">
                    <div class="d-flex align-items-center">
                        <span class="avatar me-3">{{ selected_receiver.username.0|upper }}</span>
                        <div>
                            <h4 class="mb-0">{{ selected_receiver.get_full_name|default:selected_receiver.username }}</h4>
                            <div class="text-muted small">{{ selected_receiver.get_role_display }}</div>
                        </div>
                    </div>
                </div>

                <div class="chat-messages d-flex flex-column" id="chat-messages">
                    {% for msg in chat_messages %}
                        <div class="message {% if msg.sender == request.user %}message-sent{% else %}message-received{% endif %}">
                            <div>{{ msg.message|linebreaksbr }}</div>
                            <span class="message-timestamp">{{ msg.timestamp|date:"P" }}</span>
                        </div>
                    {% endfor %}
                </div>

                <div class="chat-input p-3">
                    <div class="input-group">
                        <input type="text" class="form-control" placeholder="Type a message..." id="chat-message-input">
                        <button class="btn btn-primary" type="button" id="chat-message-submit">Send</button>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="d-flex align-items-center justify-content-center h-100 text-muted">
                Select a contact to start chatting.
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if selected_receiver %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const receiverId = {{ selected_receiver.id }};
        const currentUserId = {{ request.user.id }};
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('chat-message-input');
        const messageSubmit = document.getElementById('chat-message-submit');

        // Function to scroll to the bottom of the chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        scrollToBottom();

        // --- WebSocket Connection ---
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const chatSocket = new WebSocket(
            wsProtocol + '//' + window.location.host +
            '/ws/chat/' + receiverId + '/'
        );

        chatSocket.onopen = function(e) {
            console.log('Chat socket connected.');
        };

        chatSocket.onclose = function(e) {
            console.error('Chat socket closed.');
        };

        // Receive message from WebSocket
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            const messageClass = (data.sender_id === currentUserId) ? 'message-sent' : 'message-received';
            
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', messageClass);
            messageElement.innerHTML = `
                <div>${data.message}</div>
                <span class="message-timestamp">${data.timestamp}</span>
            `;
            chatMessages.appendChild(messageElement);
            scrollToBottom();
        };

        // Send message
        function sendMessage() {
            const message = messageInput.value;
            if (message.trim() === '') return;

            chatSocket.send(JSON.stringify({
                'message': message
            }));

            messageInput.value = '';
        }

        messageSubmit.addEventListener('click', sendMessage);
        messageInput.addEventListener('keyup', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    });
</script>
{% endif %}
{% endblock %}